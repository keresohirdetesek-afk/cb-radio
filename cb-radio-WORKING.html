<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CB R√°di√≥ - WORKING VERSION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { touch-action: manipulation; -webkit-user-select: none; user-select: none; }
    </style>
</head>
<body class="bg-gray-900">
    <div id="app"></div>
    <script>
        const WS_SERVER = 'wss://cb-radio-production.up.railway.app';
        
        // TURN szerverek hozz√°adva a jobb kapcsolathoz
        const ICE_SERVERS = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
                { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' },
                { urls: 'turn:openrelay.metered.ca:443?transport=tcp', username: 'openrelayproject', credential: 'openrelayproject' }
            ]
        };

        class CBRadio {
            constructor() {
                this.channel = 19;
                this.isTransmitting = false;
                this.isMuted = false;
                this.isConnected = false;
                this.peers = [];
                this.activePeers = new Set();
                this.volume = 0;
                this.localStream = null;
                this.peerConnections = {};
                this.ws = null;
                this.audioContext = null;
                this.analyser = null;
                this.userId = null;
                
                window.addEventListener('beforeunload', () => this.cleanup());
                this.init();
            }
            
            cleanup() {
                Object.values(this.peerConnections).forEach(pc => pc && pc.close());
                this.peerConnections = {};
                if (this.ws) this.ws.close();
                if (this.localStream) this.localStream.getTracks().forEach(t => t.stop());
                if (this.audioContext) this.audioContext.close();
            }
            
            async init() {
                await this.setupAudio();
                this.connectWebSocket();
                this.setupEventListeners();
                this.render();
            }
            
            async setupAudio() {
                try {
                    this.localStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            sampleRate: 48000
                        }
                    });
                    
                    this.localStream.getAudioTracks().forEach(track => track.enabled = false);
                    
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    const source = this.audioContext.createMediaStreamSource(this.localStream);
                    source.connect(this.analyser);
                    this.analyser.fftSize = 256;
                    
                    this.isConnected = true;
                    console.log('‚úÖ Mikrofon inicializ√°lva');
                    this.render();
                } catch (error) {
                    console.error('‚ùå Mikrofon hiba:', error);
                    alert('K√©rlek enged√©lyezd a mikrofon hozz√°f√©r√©st!');
                }
            }
            
            connectWebSocket() {
                this.ws = new WebSocket(WS_SERVER);
                
                this.ws.onopen = () => {
                    console.log('‚úÖ WebSocket csatlakozva');
                    this.joinChannel(this.channel);
                };
                
                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                };
                
                this.ws.onerror = (error) => console.error('‚ùå WebSocket hiba:', error);
                
                this.ws.onclose = () => {
                    console.log('‚ö†Ô∏è WebSocket bez√°rult, √∫jracsatlakoz√°s...');
                    this.isConnected = false;
                    this.render();
                    setTimeout(() => this.connectWebSocket(), 3000);
                };
            }
            
            async handleWebSocketMessage(data) {
                console.log('üì® √úzenet:', data.type);
                
                switch (data.type) {
                    case 'channel-joined':
                        this.userId = data.userId;
                        this.peers = data.peers;
                        console.log(`‚úÖ Csatorna ${data.channelId}, Peers: ${data.peers.length}`);
                        for (const peerId of data.peers) {
                            await this.createPeerConnection(peerId, true);
                        }
                        this.render();
                        break;
                        
                    case 'peer-joined':
                        if (!this.peers.includes(data.userId)) {
                            console.log('üë§ √öj peer csatlakozott:', data.userId);
                            this.peers.push(data.userId);
                            this.render();
                        }
                        break;
                        
                    case 'peer-left':
                        console.log('üëã Peer kil√©pett:', data.userId);
                        this.peers = this.peers.filter(id => id !== data.userId);
                        this.closePeerConnection(data.userId);
                        this.render();
                        break;
                        
                    case 'offer':
                        console.log('üìû Offer √©rkezett:', data.from);
                        await this.handleOffer(data);
                        break;
                        
                    case 'answer':
                        console.log('‚úÖ Answer √©rkezett:', data.from);
                        await this.handleAnswer(data);
                        break;
                        
                    case 'ice-candidate':
                        await this.handleIceCandidate(data);
                        break;
                        
                    case 'peer-transmitting':
                        if (data.transmitting) {
                            console.log('üé§ Peer ad:', data.userId);
                            this.activePeers.add(data.userId);
                        } else {
                            console.log('üîá Peer befejezte:', data.userId);
                            this.activePeers.delete(data.userId);
                        }
                        this.render();
                        break;
                }
            }
            
            joinChannel(channelId) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'join-channel', channel: channelId }));
                }
            }
            
            async createPeerConnection(peerId, initiator = false) {
                if (this.peerConnections[peerId]) {
                    console.log('‚ôªÔ∏è Peer connection m√°r l√©tezik, lez√°r√°s...', peerId);
                    this.peerConnections[peerId].close();
                }
                
                console.log(`üîó Peer connection l√©trehoz√°sa: ${peerId} (initiator: ${initiator})`);
                const pc = new RTCPeerConnection(ICE_SERVERS);
                this.peerConnections[peerId] = pc;
                
                // Local stream hozz√°ad√°sa
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => {
                        console.log('‚ûï Track hozz√°ad√°sa:', track.kind);
                        pc.addTrack(track, this.localStream);
                    });
                }
                
                // Remote stream kezel√©se
                pc.ontrack = (event) => {
                    console.log('üîä Remote track √©rkezett:', event.track.kind);
                    const [remoteStream] = event.streams;
                    this.playRemoteAudio(remoteStream, peerId);
                };
                
                // ICE candidates
                pc.onicecandidate = (event) => {
                    if (event.candidate && this.ws && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(JSON.stringify({
                            type: 'ice-candidate',
                            candidate: event.candidate,
                            to: peerId
                        }));
                    }
                };
                
                // Connection state
                pc.onconnectionstatechange = () => {
                    console.log(`üîå Connection state [${peerId}]: ${pc.connectionState}`);
                    if (pc.connectionState === 'connected') {
                        console.log('‚úÖ PEER CONNECTION SIKERES!', peerId);
                    }
                    if (pc.connectionState === 'failed' || pc.connectionState === 'closed') {
                        this.closePeerConnection(peerId);
                    }
                };
                
                // ICE connection state
                pc.oniceconnectionstatechange = () => {
                    console.log(`‚ùÑÔ∏è ICE state [${peerId}]: ${pc.iceConnectionState}`);
                };
                
                // Create offer if initiator
                if (initiator) {
                    try {
                        const offer = await pc.createOffer({
                            offerToReceiveAudio: true,
                            offerToReceiveVideo: false
                        });
                        await pc.setLocalDescription(offer);
                        console.log('üì§ Offer elk√ºldve:', peerId);
                        
                        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                            this.ws.send(JSON.stringify({
                                type: 'offer',
                                offer: pc.localDescription,
                                to: peerId
                            }));
                        }
                    } catch (err) {
                        console.error('‚ùå Offer hiba:', err);
                    }
                }
                
                return pc;
            }
            
            async handleOffer(data) {
                try {
                    const pc = await this.createPeerConnection(data.from);
                    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    console.log('üì§ Answer elk√ºldve:', data.from);
                    
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(JSON.stringify({
                            type: 'answer',
                            answer: pc.localDescription,
                            to: data.from
                        }));
                    }
                } catch (err) {
                    console.error('‚ùå Offer kezel√©si hiba:', err);
                }
            }
            
            async handleAnswer(data) {
                const pc = this.peerConnections[data.from];
                if (pc && pc.signalingState !== 'stable') {
                    try {
                        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                        console.log('‚úÖ Answer be√°ll√≠tva:', data.from);
                    } catch (err) {
                        console.error('‚ùå Answer hiba:', err);
                    }
                }
            }
            
            async handleIceCandidate(data) {
                const pc = this.peerConnections[data.from];
                if (pc && pc.remoteDescription) {
                    try {
                        await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                    } catch (err) {
                        console.error('‚ùå ICE candidate hiba:', err);
                    }
                }
            }
            
            closePeerConnection(peerId) {
                const pc = this.peerConnections[peerId];
                if (pc) {
                    pc.close();
                    delete this.peerConnections[peerId];
                }
                const audioEl = document.getElementById(`audio-${peerId}`);
                if (audioEl) audioEl.remove();
            }
            
            playRemoteAudio(stream, peerId) {
                console.log('üîä Remote audio lej√°tsz√°sa:', peerId);
                let audioElement = document.getElementById(`audio-${peerId}`);
                
                if (!audioElement) {
                    audioElement = document.createElement('audio');
                    audioElement.id = `audio-${peerId}`;
                    audioElement.autoplay = true;
                    audioElement.playsInline = true;
                    audioElement.volume = 1.0;
                    document.body.appendChild(audioElement);
                    console.log('‚úÖ Audio element l√©trehozva:', audioElement.id);
                }
                
                audioElement.srcObject = stream;
                
                // Forced play
                audioElement.play().then(() => {
                    console.log('‚úÖ Audio lej√°tsz√°s elindult:', peerId);
                }).catch(err => {
                    console.error('‚ùå Audio lej√°tsz√°si hiba:', err);
                });
            }
            
            startTransmission() {
                if (!this.isConnected || this.isMuted) return;
                
                console.log('üé§ AD√ÅS KEZD√âS');
                this.isTransmitting = true;
                if (this.localStream) {
                    this.localStream.getAudioTracks().forEach(track => {
                        track.enabled = true;
                        console.log('üé§ Mikrofon bekapcsolva:', track.label);
                    });
                }
                
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'start-transmission' }));
                }
                
                this.measureVolume();
                this.render();
            }
            
            stopTransmission() {
                console.log('üîá AD√ÅS V√âGE');
                this.isTransmitting = false;
                if (this.localStream) {
                    this.localStream.getAudioTracks().forEach(track => {
                        track.enabled = false;
                    });
                }
                
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'stop-transmission' }));
                }
                
                this.volume = 0;
                this.render();
            }
            
            measureVolume() {
                if (!this.analyser || !this.isTransmitting) return;
                const dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                this.analyser.getByteFrequencyData(dataArray);
                const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                this.volume = Math.min(100, (average / 255) * 100);
                this.render();
                if (this.isTransmitting) requestAnimationFrame(() => this.measureVolume());
            }
            
            toggleMute() {
                this.isMuted = !this.isMuted;
                if (this.isTransmitting) this.stopTransmission();
                this.render();
            }
            
            changeChannel(newChannel) {
                Object.keys(this.peerConnections).forEach(peerId => this.closePeerConnection(peerId));
                this.peers = [];
                this.activePeers.clear();
                this.channel = newChannel;
                this.joinChannel(newChannel);
                this.render();
            }
            
            setupEventListeners() {
                let isVolumePressed = false;
                window.addEventListener('keydown', (e) => {
                    if (!isVolumePressed && (e.key === 'AudioVolumeUp' || e.keyCode === 175)) {
                        e.preventDefault();
                        isVolumePressed = true;
                        this.startTransmission();
                    }
                });
                window.addEventListener('keyup', (e) => {
                    if (isVolumePressed && (e.key === 'AudioVolumeUp' || e.keyCode === 175)) {
                        e.preventDefault();
                        isVolumePressed = false;
                        this.stopTransmission();
                    }
                });
            }
            
            render() {
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-black flex items-center justify-center p-4">
                        <div class="w-full max-w-md">
                            <div class="bg-gradient-to-b from-gray-800 to-gray-900 rounded-3xl shadow-2xl border-4 border-gray-700 overflow-hidden">
                                <div class="bg-gradient-to-r from-orange-600 to-red-600 px-6 py-3 flex items-center justify-between">
                                    <span class="text-white font-bold text-lg">üìª CB R√ÅDI√ì [DEBUG]</span>
                                    <span class="text-xs font-semibold ${this.isConnected ? 'text-green-400' : 'text-red-400'}">
                                        ${this.isConnected ? '‚óè ONLINE' : '‚óã OFFLINE'}
                                    </span>
                                </div>
                                <div class="bg-gradient-to-b from-green-900 to-green-950 p-6 border-y-4 border-gray-700">
                                    <div class="bg-black rounded-lg p-4 shadow-inner">
                                        <div class="text-center mb-4">
                                            <div class="text-green-400 font-mono text-sm mb-1">CSATORNA</div>
                                            <div class="text-green-400 font-mono text-6xl font-bold tracking-wider">${String(this.channel).padStart(2, '0')}</div>
                                            <div class="text-green-400 font-mono text-xs mt-2">üë• ${this.peers.length} FELHASZN√ÅL√ì</div>
                                        </div>
                                        ${this.isTransmitting ? `
                                            <div class="mt-4">
                                                <div class="text-green-400 font-mono text-xs mb-2 text-center">AD√ÅS</div>
                                                <div class="h-3 bg-gray-900 rounded-full overflow-hidden border border-green-800">
                                                    <div class="h-full bg-gradient-to-r from-green-600 to-green-400 transition-all duration-100" style="width: ${this.volume}%"></div>
                                                </div>
                                            </div>
                                        ` : this.activePeers.size > 0 ? `
                                            <div class="mt-4 text-center"><div class="text-yellow-400 font-mono text-xs animate-pulse">V√âTEL...</div></div>
                                        ` : `
                                            <div class="mt-4 text-center"><div class="text-green-400 font-mono text-xs animate-pulse">K√âSZENL√âTI</div></div>
                                        `}
                                    </div>
                                </div>
                                <div class="p-6 bg-gray-800">
                                    <div class="mb-4">
                                        <label class="text-gray-300 text-sm font-semibold mb-2 block">Csatorna (1-40)</label>
                                        <div class="flex gap-2">
                                            <button id="channelDown" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-bold text-xl">‚óÄ</button>
                                            <input type="range" id="channelSlider" min="1" max="40" value="${this.channel}" class="flex-1">
                                            <button id="channelUp" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-bold text-xl">‚ñ∂</button>
                                        </div>
                                    </div>
                                    <button id="muteBtn" class="w-full mb-4 px-6 py-3 rounded-lg font-semibold ${this.isMuted ? 'bg-red-600' : 'bg-gray-700'} text-white">
                                        ${this.isMuted ? 'üîá N√âM√çTVA' : 'üîä HANG BE'}
                                    </button>
                                    <button id="pttBtn" class="w-full py-8 rounded-2xl font-bold text-xl shadow-lg select-none ${
                                        this.isTransmitting ? 'bg-gradient-to-b from-red-500 to-red-700 scale-95' :
                                        this.isConnected && !this.isMuted ? 'bg-gradient-to-b from-green-500 to-green-700 hover:scale-105' :
                                        'bg-gray-600 cursor-not-allowed'
                                    } text-white" ${!this.isConnected || this.isMuted ? 'disabled' : ''}>
                                        ${this.isTransmitting ? 'üé§ AD√ÅS...' : 'üîá NYOMD √âS BESZ√âLJ'}
                                    </button>
                                    <p class="text-gray-400 text-xs mt-3 text-center">F12 ‚Üí Console: Debug √ºzenetek</p>
                                </div>
                                <div class="bg-gray-900 px-6 py-3 border-t-2 border-gray-700">
                                    <p class="text-gray-400 text-xs text-center">${this.isConnected ? `Csatorna ${this.channel}` : 'Mikrofon sz√ºks√©ges'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const pttBtn = document.getElementById('pttBtn');
                if (pttBtn) {
                    pttBtn.addEventListener('mousedown', () => this.startTransmission());
                    pttBtn.addEventListener('mouseup', () => this.stopTransmission());
                    pttBtn.addEventListener('touchstart', (e) => { e.preventDefault(); this.startTransmission(); });
                    pttBtn.addEventListener('touchend', (e) => { e.preventDefault(); this.stopTransmission(); });
                }
                document.getElementById('muteBtn')?.addEventListener('click', () => this.toggleMute());
                document.getElementById('channelDown')?.addEventListener('click', () => this.changeChannel(Math.max(1, this.channel - 1)));
                document.getElementById('channelUp')?.addEventListener('click', () => this.changeChannel(Math.min(40, this.channel + 1)));
                document.getElementById('channelSlider')?.addEventListener('input', (e) => this.changeChannel(parseInt(e.target.value)));
            }
        }
        
        new CBRadio();
    </script>
</body>
</html>
