<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CB R√°di√≥ v4.0 - Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-window {
            position: fixed;
            background: rgba(17, 24, 39, 0.95);
            border: 2px solid #fde047;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .chat-window.minimized {
            height: 50px !important;
            overflow: hidden;
        }
        .chat-header {
            cursor: move;
            user-select: none;
        }
        .chat-messages {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #fde047 #1f2937;
        }
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #fde047;
            border-radius: 3px;
        }
        .message-bubble {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-900">
    <div id="app"></div>
    <div id="chatWindow"></div>
    
    <script>
        const WS_SERVER = 'wss://cb-radio-production.up.railway.app';
        
        const ICE_SERVERS = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' }
            ]
        };

        class CBRadio {
            constructor() {
                this.channel = 19;
                this.isTransmitting = false;
                this.isMuted = false;
                this.isConnected = false;
                this.peers = [];
                this.activePeers = new Set();
                this.volume = 0;
                this.rogerBeepEnabled = true;
                this.localStream = null;
                this.peerConnections = {};
                this.ws = null;
                this.audioContext = null;
                this.analyser = null;
                this.userId = null;
                this.spacePressed = false;
                
                // Chat features
                this.chatEnabled = false;
                this.chatMessages = [];
                this.chatWindow = {
                    open: false,
                    minimized: false,
                    x: window.innerWidth - 350,
                    y: window.innerHeight - 500,
                    width: 320,
                    height: 450
                };
                this.recognition = null;
                this.isRecognizing = false;
                
                window.addEventListener('beforeunload', () => this.cleanup());
                this.init();
            }
            
            cleanup() {
                Object.values(this.peerConnections).forEach(pc => pc && pc.close());
                if (this.ws) this.ws.close();
                if (this.localStream) this.localStream.getTracks().forEach(t => t.stop());
                if (this.audioContext) this.audioContext.close();
                if (this.recognition) this.recognition.stop();
            }
            
            async init() {
                await this.setupAudio();
                this.connectWebSocket();
                this.setupEventListeners();
                this.loadChatSettings();
                this.render();
            }
            
            async setupAudio() {
                try {
                    this.localStream = await navigator.mediaDevices.getUserMedia({
                        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
                    });
                    this.localStream.getAudioTracks().forEach(track => track.enabled = false);
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    const source = this.audioContext.createMediaStreamSource(this.localStream);
                    source.connect(this.analyser);
                    this.analyser.fftSize = 256;
                    this.isConnected = true;
                    this.render();
                } catch (error) {
                    alert('K√©rlek enged√©lyezd a mikrofon hozz√°f√©r√©st!');
                }
            }
            
            setupSpeechRecognition() {
                if (!('webkitSpeechRecognition' in window)) {
                    console.log('‚ùå Speech recognition NOT supported in this browser');
                    alert('A besz√©dfelismer√©s nem t√°mogatott ebben a b√∂ng√©sz≈ëben. Haszn√°lj Chrome-ot vagy Edge-et!');
                    return;
                }
                
                console.log('‚úÖ Speech Recognition inicializ√°lva');
                
                this.recognition = new webkitSpeechRecognition();
                this.recognition.lang = 'hu-HU';
                this.recognition.continuous = true;
                this.recognition.interimResults = false;
                
                this.recognition.onstart = () => {
                    console.log('üé§ Speech Recognition ELINDULT');
                };
                
                this.recognition.onend = () => {
                    console.log('üîá Speech Recognition LE√ÅLLT');
                    this.isRecognizing = false;
                };
                
                this.recognition.onresult = (event) => {
                    const last = event.results.length - 1;
                    const transcript = event.results[last][0].transcript;
                    const confidence = event.results[last][0].confidence;
                    
                    console.log(`üìù Felismert sz√∂veg: "${transcript}" (${Math.round(confidence * 100)}% bizonyoss√°g)`);
                    
                    if (confidence > 0.7) {
                        console.log('‚úÖ Elfogadva (70% felett)');
                        this.addChatMessage('Te', transcript, true);
                        // Send to other peers
                        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                            this.ws.send(JSON.stringify({
                                type: 'chat-message',
                                text: transcript,
                                userId: this.userId
                            }));
                        }
                    } else {
                        console.log(`‚ùå Elutas√≠tva (${Math.round(confidence * 100)}% < 70%)`);
                    }
                };
                
                this.recognition.onerror = (event) => {
                    console.error('‚ùå Speech recognition HIBA:', event.error);
                    if (event.error === 'not-allowed') {
                        alert('Mikrofon enged√©ly megtagadva! Enged√©lyezd a mikrofont a besz√©dfelismer√©shez!');
                    } else if (event.error === 'network') {
                        console.log('‚ö†Ô∏è H√°l√≥zati hiba - ellen≈ërizd az internet kapcsolatot');
                    } else if (event.error === 'no-speech') {
                        console.log('üîá Nem hallott besz√©det');
                    }
                };
            }
            
            connectWebSocket() {
                this.ws = new WebSocket(WS_SERVER);
                this.ws.onopen = () => {
                    this.isConnected = true;
                    this.joinChannel(this.channel);
                    this.render();
                };
                this.ws.onmessage = (event) => this.handleWebSocketMessage(JSON.parse(event.data));
                this.ws.onclose = () => {
                    this.isConnected = false;
                    this.render();
                    setTimeout(() => this.connectWebSocket(), 3000);
                };
            }
            
            async handleWebSocketMessage(data) {
                switch (data.type) {
                    case 'channel-joined':
                        this.userId = data.userId;
                        this.peers = data.peers;
                        for (const peerId of data.peers) await this.createPeerConnection(peerId, true);
                        this.render();
                        break;
                    case 'peer-joined':
                        if (!this.peers.includes(data.userId)) this.peers.push(data.userId);
                        this.render();
                        break;
                    case 'peer-left':
                        this.peers = this.peers.filter(id => id !== data.userId);
                        this.closePeerConnection(data.userId);
                        this.render();
                        break;
                    case 'offer':
                        await this.handleOffer(data);
                        break;
                    case 'answer':
                        await this.handleAnswer(data);
                        break;
                    case 'ice-candidate':
                        await this.handleIceCandidate(data);
                        break;
                    case 'peer-transmitting':
                        if (data.transmitting) this.activePeers.add(data.userId);
                        else this.activePeers.delete(data.userId);
                        this.render();
                        break;
                    case 'chat-message':
                        const userName = data.userId.substring(0, 8);
                        this.addChatMessage(userName, data.text, false);
                        break;
                }
            }
            
            joinChannel(channelId) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'join-channel', channel: channelId }));
                }
            }
            
            async createPeerConnection(peerId, initiator = false) {
                if (this.peerConnections[peerId]) this.peerConnections[peerId].close();
                const pc = new RTCPeerConnection(ICE_SERVERS);
                this.peerConnections[peerId] = pc;
                if (this.localStream) this.localStream.getTracks().forEach(track => pc.addTrack(track, this.localStream));
                pc.ontrack = (event) => this.playRemoteAudio(event.streams[0], peerId);
                pc.onicecandidate = (event) => {
                    if (event.candidate && this.ws) {
                        this.ws.send(JSON.stringify({ type: 'ice-candidate', candidate: event.candidate, to: peerId }));
                    }
                };
                if (initiator) {
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    if (this.ws) this.ws.send(JSON.stringify({ type: 'offer', offer: pc.localDescription, to: peerId }));
                }
                return pc;
            }
            
            async handleOffer(data) {
                const pc = await this.createPeerConnection(data.from);
                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                if (this.ws) this.ws.send(JSON.stringify({ type: 'answer', answer: pc.localDescription, to: data.from }));
            }
            
            async handleAnswer(data) {
                const pc = this.peerConnections[data.from];
                if (pc && pc.signalingState !== 'stable') await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            }
            
            async handleIceCandidate(data) {
                const pc = this.peerConnections[data.from];
                if (pc && pc.remoteDescription) await pc.addIceCandidate(new RTCIceCandidate(data.candidate)).catch(() => {});
            }
            
            closePeerConnection(peerId) {
                if (this.peerConnections[peerId]) this.peerConnections[peerId].close();
                delete this.peerConnections[peerId];
                const audioEl = document.getElementById(`audio-${peerId}`);
                if (audioEl) audioEl.remove();
            }
            
            playRemoteAudio(stream, peerId) {
                let audioElement = document.getElementById(`audio-${peerId}`);
                if (!audioElement) {
                    audioElement = document.createElement('audio');
                    audioElement.id = `audio-${peerId}`;
                    audioElement.autoplay = true;
                    audioElement.playsInline = true;
                    document.body.appendChild(audioElement);
                }
                audioElement.srcObject = stream;
                audioElement.volume = 1.0;
                audioElement.play().catch(() => {});
            }
            
            playAuthenticCBRogerBeep() {
                if (!this.rogerBeepEnabled || !this.audioContext) return;
                const currentTime = this.audioContext.currentTime;
                const osc1 = this.audioContext.createOscillator();
                const gain1 = this.audioContext.createGain();
                osc1.connect(gain1);
                gain1.connect(this.audioContext.destination);
                osc1.frequency.value = 1750;
                osc1.type = 'sine';
                gain1.gain.setValueAtTime(0.25, currentTime);
                gain1.gain.exponentialRampToValueAtTime(0.01, currentTime + 0.08);
                osc1.start(currentTime);
                osc1.stop(currentTime + 0.08);
                const osc2 = this.audioContext.createOscillator();
                const gain2 = this.audioContext.createGain();
                osc2.connect(gain2);
                gain2.connect(this.audioContext.destination);
                osc2.frequency.value = 1450;
                osc2.type = 'sine';
                gain2.gain.setValueAtTime(0, currentTime + 0.09);
                gain2.gain.setValueAtTime(0.25, currentTime + 0.09);
                gain2.gain.exponentialRampToValueAtTime(0.01, currentTime + 0.21);
                osc2.start(currentTime + 0.09);
                osc2.stop(currentTime + 0.21);
            }
            
            startTransmission() {
                if (!this.isConnected || this.isMuted) return;
                this.isTransmitting = true;
                if (this.localStream) this.localStream.getAudioTracks().forEach(track => track.enabled = true);
                if (this.ws) this.ws.send(JSON.stringify({ type: 'start-transmission' }));
                
                // Start speech recognition if chat enabled
                if (this.chatEnabled && this.recognition && !this.isRecognizing) {
                    console.log('üé§ PTT megnyomva - Speech Recognition ind√≠t√°sa...');
                    try {
                        this.recognition.start();
                        this.isRecognizing = true;
                        console.log('‚úÖ Recognition.start() megh√≠vva');
                    } catch (e) {
                        console.log('‚ö†Ô∏è Recognition m√°r fut:', e.message);
                    }
                } else if (this.chatEnabled && !this.recognition) {
                    console.log('‚ùå HIBA: Chat enged√©lyezve de recognition objektum nincs!');
                } else if (!this.chatEnabled) {
                    console.log('‚ÑπÔ∏è Chat nincs enged√©lyezve - nincs sz√∂vegfelismer√©s');
                }
                
                this.measureVolume();
                this.render();
            }
            
            stopTransmission() {
                this.isTransmitting = false;
                if (this.localStream) this.localStream.getAudioTracks().forEach(track => track.enabled = false);
                if (this.ws) this.ws.send(JSON.stringify({ type: 'stop-transmission' }));
                this.volume = 0;
                
                // Stop speech recognition
                if (this.recognition && this.isRecognizing) {
                    try {
                        this.recognition.stop();
                        this.isRecognizing = false;
                    } catch (e) {}
                }
                
                this.playAuthenticCBRogerBeep();
                this.render();
            }
            
            measureVolume() {
                if (!this.analyser || !this.isTransmitting) return;
                const dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                this.analyser.getByteFrequencyData(dataArray);
                const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                this.volume = Math.min(100, (average / 255) * 100);
                this.render();
                if (this.isTransmitting) requestAnimationFrame(() => this.measureVolume());
            }
            
            toggleMute() {
                this.isMuted = !this.isMuted;
                if (this.isTransmitting) this.stopTransmission();
                this.render();
            }
            
            toggleRogerBeep() {
                this.rogerBeepEnabled = !this.rogerBeepEnabled;
                this.render();
            }
            
            toggleChat() {
                this.chatEnabled = !this.chatEnabled;
                console.log(`üìù Chat ${this.chatEnabled ? 'BEKAPCSOLVA' : 'KIKAPCSOLVA'}`);
                
                if (this.chatEnabled) {
                    this.setupSpeechRecognition();
                    this.openChatWindow();
                } else {
                    if (this.recognition) {
                        this.recognition.stop();
                        this.recognition = null;
                        console.log('üîá Speech Recognition le√°ll√≠tva');
                    }
                    this.closeChatWindow();
                }
                this.saveChatSettings();
                this.render();
            }
            
            openChatWindow() {
                this.chatWindow.open = true;
                this.chatWindow.minimized = false;
                this.renderChatWindow();
            }
            
            closeChatWindow() {
                this.chatWindow.open = false;
                this.renderChatWindow();
            }
            
            toggleMinimizeChat() {
                this.chatWindow.minimized = !this.chatWindow.minimized;
                this.renderChatWindow();
            }
            
            addChatMessage(sender, text, isMe) {
                const timestamp = new Date().toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit' });
                this.chatMessages.push({ sender, text, timestamp, isMe });
                if (this.chatMessages.length > 50) this.chatMessages.shift();
                this.saveChatMessages();
                this.renderChatWindow();
                setTimeout(() => this.scrollChatToBottom(), 100);
            }
            
            clearChat() {
                if (confirm('T√∂r√∂l√∂d a besz√©lget√©s t√∂rt√©netet?')) {
                    this.chatMessages = [];
                    this.saveChatMessages();
                    this.renderChatWindow();
                }
            }
            
            downloadChat() {
                const content = `CB R√°di√≥ - Csatorna ${this.channel}\nD√°tum: ${new Date().toLocaleDateString('hu-HU')}\n${'‚îÄ'.repeat(40)}\n\n` +
                    this.chatMessages.map(m => `[${m.timestamp}] ${m.sender}:\n${m.text}\n`).join('\n') +
                    `\n${'‚îÄ'.repeat(40)}\npilotRADAR.hu CB R√°di√≥`;
                
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `CB-Radio-Ch${this.channel}-${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }
            
            scrollChatToBottom() {
                const messagesEl = document.getElementById('chatMessages');
                if (messagesEl) messagesEl.scrollTop = messagesEl.scrollHeight;
            }
            
            saveChatSettings() {
                localStorage.setItem('cbRadioChatEnabled', this.chatEnabled);
                localStorage.setItem('cbRadioChatWindow', JSON.stringify(this.chatWindow));
            }
            
            loadChatSettings() {
                const enabled = localStorage.getItem('cbRadioChatEnabled');
                if (enabled === 'true') {
                    this.chatEnabled = true;
                    this.setupSpeechRecognition();
                }
                const windowData = localStorage.getItem('cbRadioChatWindow');
                if (windowData) {
                    this.chatWindow = { ...this.chatWindow, ...JSON.parse(windowData) };
                }
                this.loadChatMessages();
            }
            
            saveChatMessages() {
                localStorage.setItem('cbRadioChatMessages', JSON.stringify(this.chatMessages));
            }
            
            loadChatMessages() {
                const messages = localStorage.getItem('cbRadioChatMessages');
                if (messages) this.chatMessages = JSON.parse(messages);
            }
            
            changeChannel(newChannel) {
                Object.keys(this.peerConnections).forEach(peerId => this.closePeerConnection(peerId));
                this.peers = [];
                this.activePeers.clear();
                this.channel = newChannel;
                this.joinChannel(newChannel);
                this.render();
            }
            
            setupEventListeners() {
                window.addEventListener('keydown', (e) => {
                    if (!this.spacePressed && e.code === 'Space') {
                        e.preventDefault();
                        this.spacePressed = true;
                        this.startTransmission();
                    }
                });
                window.addEventListener('keyup', (e) => {
                    if (this.spacePressed && e.code === 'Space') {
                        e.preventDefault();
                        this.spacePressed = false;
                        this.stopTransmission();
                    }
                });
            }
            
            setupChatWindowDrag() {
                const header = document.getElementById('chatHeader');
                const window = document.getElementById('chatWindowContainer');
                if (!header || !window) return;
                
                let isDragging = false;
                let currentX, currentY, initialX, initialY;
                
                header.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    initialX = e.clientX - this.chatWindow.x;
                    initialY = e.clientY - this.chatWindow.y;
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    this.chatWindow.x = currentX;
                    this.chatWindow.y = currentY;
                    window.style.left = currentX + 'px';
                    window.style.top = currentY + 'px';
                });
                
                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        this.saveChatSettings();
                    }
                });
            }
            
            renderChatWindow() {
                const container = document.getElementById('chatWindow');
                if (!this.chatWindow.open) {
                    container.innerHTML = '';
                    return;
                }
                
                container.innerHTML = `
                    <div id="chatWindowContainer" class="chat-window ${this.chatWindow.minimized ? 'minimized' : ''}" 
                         style="left: ${this.chatWindow.x}px; top: ${this.chatWindow.y}px; width: ${this.chatWindow.width}px; height: ${this.chatWindow.height}px;">
                        <div id="chatHeader" class="chat-header bg-gradient-to-r from-yellow-400 to-yellow-500 px-4 py-2 flex items-center justify-between rounded-t-lg">
                            <span class="text-gray-900 font-bold text-sm">üí¨ Besz√©lget√©s - Ch ${this.channel}</span>
                            <div class="flex gap-2">
                                <button id="minimizeChat" class="text-gray-900 hover:text-gray-700 font-bold">‚îÄ</button>
                                <button id="closeChat" class="text-gray-900 hover:text-red-600 font-bold">‚úï</button>
                            </div>
                        </div>
                        ${!this.chatWindow.minimized ? `
                            <div id="chatMessages" class="chat-messages p-3 space-y-2" style="height: ${this.chatWindow.height - 110}px;">
                                ${this.chatMessages.length === 0 ? `
                                    <div class="text-center text-gray-500 text-sm mt-8">
                                        <p>üìù Nincs √ºzenet</p>
                                        <p class="text-xs mt-2">Nyomd meg a PTT gombot √©s besz√©lj!</p>
                                    </div>
                                ` : this.chatMessages.map(m => `
                                    <div class="message-bubble ${m.isMe ? 'text-right' : 'text-left'}">
                                        <div class="inline-block max-w-[80%] ${m.isMe ? 'bg-green-700' : 'bg-gray-700'} rounded-lg px-3 py-2">
                                            <div class="text-xs text-gray-300 mb-1">
                                                ${m.isMe ? 'üé§' : 'üìª'} ${m.sender} ‚Ä¢ ${m.timestamp}
                                            </div>
                                            <div class="text-white text-sm">${m.text}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="px-3 py-2 bg-gray-800 rounded-b-lg flex gap-2">
                                <button id="downloadChat" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-semibold">
                                    üíæ Ment√©s
                                </button>
                                <button id="clearChat" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm font-semibold">
                                    üóëÔ∏è T√∂rl√©s
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('closeChat')?.addEventListener('click', () => this.closeChatWindow());
                    document.getElementById('minimizeChat')?.addEventListener('click', () => this.toggleMinimizeChat());
                    document.getElementById('downloadChat')?.addEventListener('click', () => this.downloadChat());
                    document.getElementById('clearChat')?.addEventListener('click', () => this.clearChat());
                    this.setupChatWindowDrag();
                }, 0);
            }
            
            render() {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-black flex items-center justify-center p-4">
                        <div class="w-full max-w-md">
                            <div class="bg-gradient-to-b from-gray-800 to-gray-900 rounded-3xl shadow-2xl border-4 border-gray-700">
                                <div class="px-6 py-3" style="background: linear-gradient(135deg, #fef08a 0%, #fde047 100%);">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-gray-900 font-bold text-lg">üìª CB R√ÅDI√ì</span>
                                        <span class="text-xs font-semibold ${this.isConnected ? 'text-green-600' : 'text-red-600'}">
                                            ${this.isConnected ? '‚óè ONLINE' : '‚óã OFFLINE'}
                                        </span>
                                    </div>
                                    <div class="text-center">
                                        <span class="font-bold" style="color: #dc2626;">pilot</span><span class="font-bold text-black">RADAR</span><span class="text-black text-sm">.hu</span>
                                    </div>
                                </div>
                                <div class="bg-gradient-to-b from-green-900 to-green-950 p-6 border-y-4 border-gray-700">
                                    <div class="bg-black rounded-lg p-4">
                                        <div class="text-center mb-4">
                                            <div class="text-green-400 font-mono text-sm mb-1">CSATORNA</div>
                                            <div class="text-green-400 font-mono text-6xl font-bold">${String(this.channel).padStart(2, '0')}</div>
                                            <div class="text-green-400 font-mono text-xs mt-2">üë• ${this.peers.length} FELHASZN√ÅL√ì</div>
                                        </div>
                                        ${this.isTransmitting ? `
                                            <div class="mt-4">
                                                <div class="text-green-400 font-mono text-xs mb-2 text-center">AD√ÅS</div>
                                                <div class="h-3 bg-gray-900 rounded-full border border-green-800">
                                                    <div class="h-full bg-gradient-to-r from-green-600 to-green-400" style="width: ${this.volume}%"></div>
                                                </div>
                                            </div>
                                        ` : this.activePeers.size > 0 ? `
                                            <div class="mt-4 text-center">
                                                <div class="text-yellow-400 font-mono text-xs animate-pulse">V√âTEL...</div>
                                            </div>
                                        ` : `
                                            <div class="mt-4 text-center">
                                                <div class="text-green-400 font-mono text-xs animate-pulse">K√âSZENL√âTI</div>
                                            </div>
                                        `}
                                    </div>
                                </div>
                                <div class="p-6 bg-gray-800 space-y-4">
                                    <div>
                                        <label class="text-gray-300 text-sm font-semibold mb-2 block">Csatorna (1-40)</label>
                                        <div class="flex gap-2">
                                            <button id="channelDown" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-bold">‚óÄ</button>
                                            <input type="range" id="channelSlider" min="1" max="40" value="${this.channel}" class="flex-1">
                                            <button id="channelUp" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-bold">‚ñ∂</button>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3">
                                        <button id="rogerBtn" class="px-4 py-3 rounded-lg font-semibold text-sm ${this.rogerBeepEnabled ? 'bg-green-600' : 'bg-gray-700'} text-white">
                                            ${this.rogerBeepEnabled ? 'üîî BEEP: BE' : 'üîï BEEP: KI'}
                                        </button>
                                        <button id="muteBtn" class="px-4 py-3 rounded-lg font-semibold text-sm ${this.isMuted ? 'bg-red-600' : 'bg-gray-700'} text-white">
                                            ${this.isMuted ? 'üîá N√âM√çTVA' : 'üîä HANG BE'}
                                        </button>
                                    </div>
                                    
                                    <button id="chatBtn" class="w-full px-4 py-3 rounded-lg font-semibold text-sm ${this.chatEnabled ? 'bg-blue-600' : 'bg-gray-700'} text-white">
                                        ${this.chatEnabled ? 'üìù SZ√ñVEG: BE' : 'üìù SZ√ñVEG: KI'}
                                    </button>
                                    
                                    <button id="pttBtn" class="w-full py-12 rounded-2xl font-bold text-2xl shadow-2xl select-none active:scale-95 transition-all ${
                                        this.isTransmitting ? 'bg-gradient-to-b from-red-500 to-red-700 shadow-red-500/50' :
                                        this.isConnected && !this.isMuted ? 'bg-gradient-to-b from-green-500 to-green-700 shadow-green-500/50 hover:shadow-green-500/70' :
                                        'bg-gray-600'
                                    } text-white" ${!this.isConnected || this.isMuted ? 'disabled' : ''}>
                                        ${this.isTransmitting ? 'üé§ AD√ÅS...' : 'üé§ NYOMD √âS BESZ√âLJ'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const pttBtn = document.getElementById('pttBtn');
                if (pttBtn) {
                    pttBtn.addEventListener('mousedown', () => this.startTransmission());
                    pttBtn.addEventListener('mouseup', () => this.stopTransmission());
                    pttBtn.addEventListener('touchstart', (e) => { e.preventDefault(); this.startTransmission(); });
                    pttBtn.addEventListener('touchend', (e) => { e.preventDefault(); this.stopTransmission(); });
                }
                
                document.getElementById('muteBtn')?.addEventListener('click', () => this.toggleMute());
                document.getElementById('rogerBtn')?.addEventListener('click', () => this.toggleRogerBeep());
                document.getElementById('chatBtn')?.addEventListener('click', () => this.toggleChat());
                document.getElementById('channelDown')?.addEventListener('click', () => this.changeChannel(Math.max(1, this.channel - 1)));
                document.getElementById('channelUp')?.addEventListener('click', () => this.changeChannel(Math.min(40, this.channel + 1)));
                document.getElementById('channelSlider')?.addEventListener('input', (e) => this.changeChannel(parseInt(e.target.value)));
            }
        }
        
        new CBRadio();
    </script>
</body>
</html>
